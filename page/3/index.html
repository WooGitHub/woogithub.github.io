<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Justin写字的地方</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="justin huang" />
  <meta name="description" content="Justin写字的地方" />
  <meta name="keywords" content="Justin, JustinHuang, ShareCore" />






<meta name="generator" content="Hugo 0.54.0" />


<link rel="canonical" href="http://sharecore.net/" />
<link href="http://sharecore.net/index.xml" rel="alternate" type="application/rss+xml" title="Justin写字的地方" />
  <link href="http://sharecore.net/index.xml" rel="feed" type="application/rss+xml" title="Justin写字的地方" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/contrib/auto-render.min.js"></script>


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">







<link href="/dist/even.min.css?v=3.2.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="Justin写字的地方" />
<meta property="og:description" content="Justin写字的地方" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://sharecore.net/" />

<meta property="og:updated_time" content="2013-08-25T00:32:10&#43;00:00"/>

<meta itemprop="name" content="Justin写字的地方">
<meta itemprop="description" content="Justin写字的地方">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Justin写字的地方"/>
<meta name="twitter:description" content="Justin写字的地方"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Justin&#39;s Notes</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Justin&#39;s Notes</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          
  <section id="posts" class="posts">
    
    
    
      <article class="post">
  <header class="post-header">
    <h1 class="post-title"><a class="post-link" href="/post/linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8D%81%E9%97%AE/">Linux文件系统十问</a></h1>
    <div class="post-meta">
      <span class="post-time"> 2013-08-25 </span>
      
      
    </div>
  </header>
  
  <div class="post-content">
    <div class="post-summary">
      今天读到这篇文章:Linux文件系统十问，你知道吗？，作了个总结笔记： 1、机械磁盘随机读写时速度非常慢，操作系统是采用什么技巧来提高随机读写
    </div>
    <div class="read-more">
      <a href="/post/linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8D%81%E9%97%AE/" class="read-more-link">阅读更多</a>
    </div>
  </div>
</article>

    
      <article class="post">
  <header class="post-header">
    <h1 class="post-title"><a class="post-link" href="/post/%E6%80%8E%E4%B9%88%E5%86%99go%E7%9A%84%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/">怎么写Go的基准测试</a></h1>
    <div class="post-meta">
      <span class="post-time"> 2013-07-04 </span>
      
      
    </div>
  </header>
  
  <div class="post-content">
    <div class="post-summary">
      Dave Cheney在他的blog写了一篇关于Go的基准测试编写的基本介绍(链接)。我以此为内容，整理输出内容。 对自己编写package编写基准测
    </div>
    <div class="read-more">
      <a href="/post/%E6%80%8E%E4%B9%88%E5%86%99go%E7%9A%84%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" class="read-more-link">阅读更多</a>
    </div>
  </div>
</article>

    
      <article class="post">
  <header class="post-header">
    <h1 class="post-title"><a class="post-link" href="/post/%E6%98%A5%E7%A7%8B%E4%BA%94%E9%9C%B8%E4%B9%8B%E9%A6%96%E9%BD%90%E6%A1%93%E5%85%AC%E7%9A%84%E6%95%85%E4%BA%8B/">春秋五霸之首——齐桓公的故事</a></h1>
    <div class="post-meta">
      <span class="post-time"> 2013-06-29 </span>
      
      
    </div>
  </header>
  
  <div class="post-content">
    <div class="post-summary">
      昨晚重新翻阅了《史记·齐太公世家》，今天就跟大家重新说说春秋五霸之首齐桓公姜小白的故事吧。 在说齐桓公这位“明君”的故事前，我们得先说点“恶心
    </div>
    <div class="read-more">
      <a href="/post/%E6%98%A5%E7%A7%8B%E4%BA%94%E9%9C%B8%E4%B9%8B%E9%A6%96%E9%BD%90%E6%A1%93%E5%85%AC%E7%9A%84%E6%95%85%E4%BA%8B/" class="read-more-link">阅读更多</a>
    </div>
  </div>
</article>

    
      <article class="post">
  <header class="post-header">
    <h1 class="post-title"><a class="post-link" href="/post/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F%E8%BF%9B%E9%98%B6/">Go并发编程模式进阶</a></h1>
    <div class="post-meta">
      <span class="post-time"> 2013-06-10 </span>
      
      
    </div>
  </header>
  
  <div class="post-content">
    <div class="post-summary">
      <p>前段时间Google的<a href="http://profiles.google.com/ajmani">Sameer Ajmani</a>在Google I/O上做了关于Go的并发模式的介绍。Slides<a href="http://talks.golang.org/2013/advconc.slide">在此</a>,youtube视频<a href="http://www.youtube.com/watch?feature=player_embedded&amp;v=QDDwwePbDtw">在此</a>(注：上述链接均需翻墙)。</p>

<p>本篇的前提是对goroutine+channel的并发编程模式有基本的了解，建议能读懂下面这个经典ping-pong程序为好。</p>

<pre><code>package main

import (
	&quot;fmt&quot;
	&quot;time&quot;
)
//定义一个结构
type Ball struct{ hits int }

func main() {
	//创建一个可传输Ball的channel
	table := make(chan *Ball)
	//分别启动ping/pong的goroutine 
	go Player(&quot;Ping&quot;, table)
	go Player(&quot;Pong&quot;, table)
	//一个Ball进入channel，游戏开始
	table &lt;- new(Ball)
	//“主”程序暂停1s,等待ping/pong的goroutine执行
	time.Sleep(1 * time.Second)
	//从channel取出Ball，游戏开始
	&lt;-table
	//可通过引发异常，显示调用栈的详细信息
	//panic(&quot;show me the stacks&quot;)
}

func Player(name string, table chan *Ball) {
	for {
	    //channel取出Ball，并hits++
	    ball := &lt;-table
	    ball.hits++
	    fmt.Println(name, ball.hits)
	    //暂停1ms
	    time.Sleep(1 * time.Millisecond)
	    //将Ball放回channel
	    table &lt;- ball
	}
} 
</code></pre>

<p>ping-pong程序的执行过程，可以用下图来表示。</p>

<p><img src="/images/advgoroutine/pingpong.png" alt="ping-pong程序执行过程" /></p>

<p>接下来主要说说Go的并发编程里的一些“文艺”使用:如何通信?如何周期性处理事件？如何取消执行？这些高级用法的支持，除了依赖我们上面看到的goroutine+channel外，还要依赖于Go的一个statement：select+case。它可以用来管理和监听多个channel,从而起到“多路复用”的效果。他的基本语法如下。</p>

<pre><code>select {
	case xc &lt;- x:
		// 向channel(xc)发送一个对象(x)
	case y := &lt;-yc:
		// 从channel(yc)获取一个对象并赋值到变量(y)
}
</code></pre>

<p>下面我们以一个能持续从RSS获取资源项的例子来说明select的使用。
假设我们已经拥有下面这个接口所定义的功能：从一个RSS url获取资源项目(一次调用，获取一次,这个接口的模拟实现，见附1。)</p>

<pre><code>type Fetcher interface {
	Fetch() (items []Item, next time.Time, err error)//能从某个rss url获取它的资源项，并能同时返回下一次获取的时间next。
}
</code></pre>

<p>`我们用下面这个接口来表示我们希望达到的功能：能从rss url上循环获取资源项，形成资源流的形式；循环获取功能，可以中止。</p>

<pre><code>type Subscription interface {
	Updates() &lt;-chan Item//用channel来存放资源，即可实现流的显示
	Close() error//关闭获取
}
</code></pre>

<p>先看一个这项功能的简单实现，熟悉多线程编程的，应该觉得很眼熟。</p>

<pre><code>
type NavieSub struct {
	closed  bool
	err     error
	updates chan Item
	fetcher Fetcher
}

func (s *NavieSub) Close() error {
	s.closed = true//设置关闭标识为true
	return s.err
}
func (s *NavieSub) Updates() &lt;-chan Item {
	return s.updates//返回已经获取的资源项
}
func (s *NavieSub) loop() {//循环获取的方法实现
	for {
	    if s.closed {//判断关闭标识
	        close(s.updates)//close是内置函数
	        return
	    }
	    items, next, err := s.fetcher.Fetch()//执行一次获取
	    if err != nil {
	        s.err = err
	        time.Sleep(10 * time.Second)
	        continue//出错时暂停10秒后再开始下次循环
	    }
	    for _, item := range items {//将获取的资源项写入，用于返回
	        s.updates &lt;- item
	    }
	    if now := time.Now(); next.After(now) {//暂停到下次获取时间时，再开始下一次获取
	        time.Sleep(next.Sub(now))
	    }
	}
}

func main() {
	fetcher := &amp;FakeFether{channel: &quot;sharecore.info&quot;}
	s := &amp;NavieSub{
	    fetcher: fetcher,
	    updates: make(chan Item),
	}
	
	go s.loop()//启动一个例程执行loop方法（与启动一个线程类似）
	
	time.AfterFunc(3*time.Second, func() {
	    fmt.Println(&quot;closed&quot;, s.Close())
	})
	
	for item := range s.Updates() {
	    fmt.Println(item.Channel, item.Title)
	}
} 
</code></pre>

<p>`那以上的简单实现，会有什么问题呢？</p>

<p>首先，<strong>明显发现s.err和s.closed的访问是非同步的。</strong></p>

<pre><code>s.closed = true //设置关闭标识为true

if s.closed {//判断关闭标识
	        close(s.updates) //close是内置函数
	        return
	    }
</code></pre>

<p>`然后，我们看到s.updates的定义如下:</p>

<pre><code>s := &amp;NavieSub{
	    fetcher: fetcher,
	    updates: make(chan Item),//定义为没有buffer的channel，一个channel中同时只能有一个元素
	}
</code></pre>

<p>`根据上面的定义，s.updates一次只能有一个item进入，当它没有其他goroutine从它里面取出元素时，下面这行代码会<strong>发生堵塞</strong>。</p>

<pre><code>s.updates &lt;- item
</code></pre>

<p>`那以上问题我们有什么办法来避免呢？</p>
    </div>
    <div class="read-more">
      <a href="/post/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F%E8%BF%9B%E9%98%B6/" class="read-more-link">阅读更多</a>
    </div>
  </div>
</article>

    
      <article class="post">
  <header class="post-header">
    <h1 class="post-title"><a class="post-link" href="/post/container%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D/">Linux Container的安装与使用介绍</a></h1>
    <div class="post-meta">
      <span class="post-time"> 2013-03-17 </span>
      
      
    </div>
  </header>
  
  <div class="post-content">
    <div class="post-summary">
      今天想在机器上搭建一个我用Go写的玩的一个分布式文件小系统，可我只有一台Laptop和一台Desktop，两台都装的Ubuntu 12.04。
    </div>
    <div class="read-more">
      <a href="/post/container%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D/" class="read-more-link">阅读更多</a>
    </div>
  </div>
</article>

    
  </section>
  
  <nav class="pagination">
    
      <a class="prev" href="/page/2/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">上一页</span>
      </a>
    
  </nav>

        </div>
        

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://github.com/justinhuang917" class="iconfont icon-github" title="github"></a>
      <a href="http://weibo.com/justinhuang917" class="iconfont icon-weibo" title="weibo"></a>
  <a href="http://sharecore.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    
      2013 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">justin huang</span>
  </span>
</div>
<script>renderMathInElement(document.body);</script>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>


<script type="text/javascript" src="/dist/even.min.js?v=3.2.0"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-37230829-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
